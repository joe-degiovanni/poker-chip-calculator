<!DOCTYPE html>
<html lang="en">
<head>
  <title>Game</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
        media="screen,projection">
</head>
<body class="teal">
<main class="container">
  <h1>Poker Chip Optimizer</h1>
  <hr/>
  <a id="viewLink" href="view.html" class="waves-effect waves-teal btn-flat blue">View Only</a>
  <table id="test"></table>
  <a class="waves-effect waves-teal btn-flat green" onclick="addRow()">Add Row</a>
</main>
</body>
<script>
  class ChipRow {
    constructor(chipColor, totalCount, chipValue, playerStartCount) {
      this.chipColor = chipColor;
      this.totalCount = totalCount;
      this.chipValue = chipValue;
      this.playerStartCount = playerStartCount;
      this.playerStartValue = this.playerStartCount * this.chipValue;
    }
  }

  const allChipColors = ['White', 'Red', 'Blue', 'Green', 'Black', 'Purple',
    'Orange', 'Yellow', 'Brown', 'Pink', 'Gray', 'Gold', 'Silver'];
  var data = [];
  const defaultData = [
    new ChipRow("White", 150, 0.25, 20),
    new ChipRow("Blue", 150, 0.5, 20),
    new ChipRow("Red", 75, 5, 5),
    new ChipRow("Black", 75, 10, 1)
  ];

  function loadDataFromParam() {
    var encoded = window.location.hash.slice(1);
    if (encoded) {
      var decoded = atob(encoded);
      const rows = JSON.parse(decoded);
      data = rows.map(row => new ChipRow(
        row.chipColor,
        row.totalCount,
        row.chipValue,
        row.playerStartCount
      ));
      // update view link with new hash
      document.getElementById('viewLink').href = "view.html" + window.location.hash;
    } else {
      // default data
      data = defaultData;
      writeDataToParam();
    }
  }

  function writeDataToParam() {
    const hash = "#" + btoa(JSON.stringify(data));
    window.location.hash = hash;
    document.getElementById('viewLink').href = "view.html" + hash;
  }

  function redrawTableFromData() {
    const table = document.getElementById('test');
    table.innerHTML = `
      <tr>
        <th>Chip Color</th>
        <th>Total Count</th>
        <th>Chip Value</th>
        <th>Player Start Count</th>
        <th>Player Start Value</th>
        <th>Actions</th>
      </tr>
    `;
    if (data === undefined || data.length === 0) {
      data = defaultData;
    }
    data.forEach(rowData => {
      const chipRow = new ChipRow(
        rowData.chipColor,
        rowData.totalCount,
        rowData.chipValue,
        rowData.playerStartCount
      );
      const newRow = table.insertRow();
      const colorCell = newRow.insertCell(0);

      // Create select element for chip colors
      const select = document.createElement("select");
      select.name = "chipColor";
      allChipColors.forEach(color => {
        const option = document.createElement("option");
        option.value = color;
        option.textContent = color;
        if (color === chipRow.chipColor) {
          option.selected = true;
        }
        select.appendChild(option);
      });
      colorCell.appendChild(select);

      const totalCountCell = newRow.insertCell(1);
      totalCountCell.contentEditable = "true";
      totalCountCell.textContent = chipRow.totalCount;
      totalCountCell.onblur = () => redrawIfChanged();
      const chipValueCell = newRow.insertCell(2);
      chipValueCell.contentEditable = "true";
      chipValueCell.textContent = '$' + chipRow.chipValue.toFixed(2);
      chipValueCell.onblur = () => redrawIfChanged();
      const playerStartCountCell = newRow.insertCell(3);
      playerStartCountCell.contentEditable = "true";
      playerStartCountCell.textContent = chipRow.playerStartCount;
      playerStartCountCell.onblur = () => redrawIfChanged();
      const playerStartValueCell = newRow.insertCell(4);
      playerStartValueCell.textContent = '$' + chipRow.playerStartValue;
      const deleteRowCell = newRow.insertCell(5);
      deleteRowCell.innerHTML = '<a class="btn-flat btn-small red" onclick="deleteRow(this.parentNode.parentNode)">Delete</a>';
    });

    // add total row
    const totalRow = table.insertRow();
    totalRow.insertCell(0).textContent = 'Total';
    totalRow.insertCell(1).textContent = data.reduce((sum, row) => sum + row.totalCount, 0);
    totalRow.insertCell(2).textContent = '$' + data.reduce((sum, row) => sum + row.totalCount * row.chipValue, 0).toFixed(2);
    totalRow.insertCell(3).textContent = data.reduce((sum, row) => sum + row.playerStartCount, 0);
    totalRow.insertCell(4).textContent = '$' + data.reduce((sum, row) => sum + row.playerStartValue, 0);
    M.AutoInit();
  }

  function tableToJson() {
    const table = document.getElementById('test');
    const data = [];
    for (let i = 1; i < table.rows.length - 1; i++) {
      const row = table.rows[i];
      const rowData = new ChipRow(
        row.cells[0].querySelector('select').value,
        parseInt(row.cells[1].textContent),
        parseFloat(row.cells[2].textContent.replace('$', '')),
        parseInt(row.cells[3].textContent)
      );
      data.push(rowData);
    }
    return data;
  }

  function getRemainingColors() {
    const usedColors = tableToJson().map(row => {
      return {
        chipColor: row.chipColor
      };
    });
    const remainingColors = allChipColors.filter(color =>
      !usedColors.some(used => used.chipColor === color)
    );
    console.log('getRemainingColors called', remainingColors);
    return remainingColors;
  }

  function addRow() {
    data.push(
      new ChipRow(getRemainingColors()[0] || 'White', 100, 1, 10)
    );
    redrawTableFromData();
    writeDataToParam();
  }

  function deleteRow(row) {
    const table = document.getElementById('test');
    table.deleteRow(row.rowIndex);
    data = tableToJson();
    writeDataToParam();
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadDataFromParam();
    redrawTableFromData();
    M.AutoInit();
  });

  function redrawIfChanged() {
    data = tableToJson();
    redrawTableFromData();
    writeDataToParam();
  }

</script>
<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</html>
