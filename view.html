<!DOCTYPE html>
<html lang="en">
<head>
  <title>Game</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
        media="screen,projection">
</head>
<body class="teal">
<main class="container">
  <h1>Poker Chip Optimizer</h1>
  <hr/>
  <a href="edit.html" class="waves-effect waves-teal btn-flat blue">Edit</a>
  <table id="test">
    <tr>
      <th>Chip Color</th>
      <th>Chip Value</th>
      <th>Player Start Count</th>
      <th>Player Start Value</th>
    </tr>
  </table>
</main>
</body>
<script>
  var data = {};

  function loadDataFromParam() {
    var encoded = window.location.hash.slice(1);
    if (encoded) {
      var decoded = atob(encoded);
      data = JSON.parse(decoded);
      // update edit link with new hash
      document.querySelector('a[href="edit.html"]').href = "edit.html" + window.location.hash;
    } else {
      data = [
        {"chipColor": "White", "totalCount": 150, "chipValue": 0.25, "playerStartCount": 20, "playerStartValue": 5},
        {"chipColor": "Blue", "totalCount": 150, "chipValue": 0.5, "playerStartCount": 20, "playerStartValue": 10},
        {"chipColor": "Red", "totalCount": 75, "chipValue": 5, "playerStartCount": 5, "playerStartValue": 25},
        {"chipColor": "Black", "totalCount": 75, "chipValue": 10, "playerStartCount": 1, "playerStartValue": 10}
      ];
      redrawTableFromData();
      writeDataToParam();
    }
  }

  function writeDataToParam() {
    const hash = "#" + btoa(JSON.stringify(data));
    window.location.hash = hash;
    document.getElementById('viewLink').href = "view.html" + hash;
  }

  function redrawTableFromData() {
    if(data === undefined || data.length === 0){
      return;
    }
    const table = document.getElementById('test');
    // Clear existing rows except header
    while (table.rows.length > 1) {
      table.deleteRow(1);
    }
    data.forEach(rowData => {
      const newRow = table.insertRow();
      const colorCell = newRow.insertCell(0);
      const chipValueCell = newRow.insertCell(1);
      const playerStartCountCell = newRow.insertCell(2);
      const playerStartValueCell = newRow.insertCell(3);

      colorCell.textContent = rowData.chipColor;
      chipValueCell.textContent = '$' + rowData.chipValue.toFixed(2);
      playerStartCountCell.textContent = rowData.playerStartCount;
      playerStartValueCell.textContent = '$' + rowData.playerStartValue.toFixed(2);
    });

    // add total row
    const totalRow = table.insertRow();
    const totalLabelCell = totalRow.insertCell(0);
    totalLabelCell.colSpan = 2;
    totalLabelCell.textContent = 'Total';
    const totalCountCell = totalRow.insertCell(1);
    const totalValueCell = totalRow.insertCell(2);
    totalCountCell.textContent = data.map(row => row.playerStartCount).reduce((a, b) => a + b, 0);
    totalValueCell.textContent = '$' + data.map(row => row.playerStartValue).reduce((a, b) => a + b, 0).toFixed(2);
  }

  document.addEventListener('DOMContentLoaded',  () => {
    loadDataFromParam();
    redrawTableFromData();
    materializeUpdateSelects();
  });

  function materializeUpdateSelects() {
    var elems = document.querySelectorAll('select');
    M.FormSelect.init(elems);
  }

</script>
<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</html>
